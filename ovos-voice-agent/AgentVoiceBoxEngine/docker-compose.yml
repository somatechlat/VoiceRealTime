# =============================================================================
# AGENTVOICEBOX - Complete Production Cluster (10GB RAM Limit)
# =============================================================================
# Project: agentvoicebox
# Port Range: 25000-25099
#
# RAM Budget (10GB Total):
#   PostgreSQL:     512MB
#   Redis:          512MB
#   Keycloak:       512MB
#   OVOS Messagebus:256MB
#   Gateway:        512MB
#   Portal API:     256MB
#   Portal Frontend:256MB
#   STT Worker:     2GB
#   TTS Worker:     1.5GB
#   LLM Worker:     512MB
#   Prometheus:     256MB
#   Grafana:        256MB
#   Lago:           1GB
#   Buffer:         ~1.5GB
#
# Run:  docker compose -p agentvoicebox up -d
# Stop: docker compose -p agentvoicebox down
#
# Port Allocation:
#   25000 - Gateway API (WebSocket/REST)
#   25001 - Portal API
#   25002 - PostgreSQL
#   25003 - Redis
#   25004 - Keycloak
#   25005 - Lago API
#   25006 - Lago Frontend
#   25007 - Portal Frontend
#   25008 - Prometheus
#   25009 - Grafana
#   25010 - OVOS Messagebus
#   25011 - Admin UI (static HTML files)
# =============================================================================

x-logging: &logging
  driver: json-file
  options:
    max-size: "5m"
    max-file: "2"

services:
  # ===========================================================================
  # INFRASTRUCTURE
  # ===========================================================================

  postgres:
    image: postgres:16-alpine
    container_name: agentvoicebox_postgres
    hostname: postgres
    environment:
      POSTGRES_USER: agentvoicebox
      POSTGRES_PASSWORD: agentvoicebox_secure_2024
      POSTGRES_DB: agentvoicebox
      POSTGRES_MULTIPLE_DATABASES: keycloak,lago
    command: >
      postgres
      -c shared_buffers=128MB
      -c effective_cache_size=256MB
      -c work_mem=2MB
      -c maintenance_work_mem=32MB
      -c max_connections=100
    ports:
      - "25002:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./docker/postgres/init-multiple-dbs.sh:/docker-entrypoint-initdb.d/init-multiple-dbs.sh:ro
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U agentvoicebox"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging: *logging
    restart: unless-stopped
    networks:
      - agentvoicebox-net

  redis:
    image: redis:7-alpine
    container_name: agentvoicebox_redis
    hostname: redis
    command: >
      redis-server
      --appendonly yes
      --maxmemory 400mb
      --maxmemory-policy volatile-lru
      --tcp-keepalive 60
    ports:
      - "25003:6379"
    volumes:
      - redis-data:/data
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    logging: *logging
    restart: unless-stopped
    networks:
      - agentvoicebox-net

  # ===========================================================================
  # OVOS - Open Voice OS Messagebus
  # ===========================================================================

  ovos-messagebus:
    image: smartgic/ovos-messagebus:latest
    container_name: agentvoicebox_ovos-messagebus
    hostname: ovos-messagebus
    ports:
      - "25010:8181"
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 8181 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging: *logging
    restart: unless-stopped
    networks:
      - agentvoicebox-net

  # ===========================================================================
  # IDENTITY - Keycloak
  # ===========================================================================

  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    container_name: agentvoicebox_keycloak
    hostname: keycloak
    command: start-dev --import-realm
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: agentvoicebox
      KC_DB_PASSWORD: agentvoicebox_secure_2024
      KC_HOSTNAME_STRICT: "false"
      KC_HEALTH_ENABLED: "true"
      JAVA_OPTS_APPEND: "-Xms256m -Xmx384m"
    ports:
      - "25004:8080"
    volumes:
      - ./keycloak/realms:/opt/keycloak/data/import:ro
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    logging: *logging
    restart: unless-stopped
    networks:
      - agentvoicebox-net


  # ===========================================================================
  # BILLING - Lago (All-in-one)
  # ===========================================================================

  lago:
    image: getlago/lago:latest
    container_name: agentvoicebox_lago
    hostname: lago
    environment:
      DATABASE_URL: postgresql://agentvoicebox:agentvoicebox_secure_2024@postgres:5432/lago
      REDIS_URL: redis://redis:6379/1
      SECRET_KEY_BASE: change-me-64-char-hex-string-for-production
      ENCRYPTION_PRIMARY_KEY: change-me-32-char-encryption-key!
      ENCRYPTION_DETERMINISTIC_KEY: change-me-32-char-determ-key!!
      ENCRYPTION_KEY_DERIVATION_SALT: change-me-salt-value
      LAGO_DISABLE_SIGNUP: "false"
      RAILS_ENV: production
      RAILS_LOG_TO_STDOUT: "true"
    ports:
      - "25005:3000"
      - "25006:80"
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    logging: *logging
    restart: unless-stopped
    networks:
      - agentvoicebox-net

  # ===========================================================================
  # APPLICATION - Gateway & Portal
  # ===========================================================================

  gateway:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: agentvoicebox_gateway
    hostname: gateway
    environment:
      FLASK_ENV: production
      APP_SECRET_KEY: change-me-in-production
      DATABASE__URI: postgresql+psycopg://agentvoicebox:agentvoicebox_secure_2024@postgres:5432/agentvoicebox
      REDIS__URL: redis://redis:6379/0
      KAFKA__BOOTSTRAP_SERVERS: localhost:9092
      OPA__URL: http://localhost:8181
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_REALM: agentvoicebox
      GATEWAY_ID: gateway-1
      GUNICORN_WORKERS: 2
    ports:
      - "25000:8000"
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    logging: *logging
    restart: unless-stopped
    networks:
      - agentvoicebox-net

  portal-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: agentvoicebox_portal-api
    hostname: portal-api
    command: ["gunicorn", "--bind", "0.0.0.0:8001", "--workers", "1", "--worker-class", "gevent", "--timeout", "60", "portal.app:app"]
    environment:
      FLASK_ENV: production
      APP_SECRET_KEY: change-me-in-production
      DATABASE__URI: postgresql+psycopg://agentvoicebox:agentvoicebox_secure_2024@postgres:5432/agentvoicebox
      REDIS__URL: redis://redis:6379/0
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_REALM: agentvoicebox
      LAGO_API_URL: http://lago:3000
    ports:
      - "25001:8001"
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    logging: *logging
    restart: unless-stopped
    networks:
      - agentvoicebox-net

  portal-frontend:
    build:
      context: ./portal-frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: http://localhost:25001
        NEXT_PUBLIC_KEYCLOAK_URL: http://localhost:25004
        NEXT_PUBLIC_KEYCLOAK_REALM: agentvoicebox
        NEXT_PUBLIC_KEYCLOAK_CLIENT_ID: portal-frontend
    container_name: agentvoicebox_portal-frontend
    hostname: portal-frontend
    ports:
      - "25007:3000"
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    depends_on:
      - portal-api
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging: *logging
    restart: unless-stopped
    networks:
      - agentvoicebox-net


  # ===========================================================================
  # WORKERS - STT, TTS, LLM
  # ===========================================================================

  stt-worker:
    build:
      context: .
      dockerfile: workers/Dockerfile.stt
    container_name: agentvoicebox_stt-worker
    hostname: stt-worker
    environment:
      REDIS_URL: redis://redis:6379/0
      STT_MODEL: tiny
      STT_DEVICE: cpu
      STT_COMPUTE_TYPE: int8
      STT_BATCH_SIZE: 2
      WORKER_ID: stt-worker-1
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; r=redis.from_url('redis://redis:6379/0'); r.ping()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    logging: *logging
    restart: unless-stopped
    networks:
      - agentvoicebox-net

  tts-worker:
    build:
      context: .
      dockerfile: workers/Dockerfile.tts
    container_name: agentvoicebox_tts-worker
    hostname: tts-worker
    environment:
      REDIS_URL: redis://redis:6379/0
      KOKORO_MODEL_DIR: /models/kokoro
      TTS_DEFAULT_VOICE: am_onyx
      TTS_DEFAULT_SPEED: "1.1"
      WORKER_ID: tts-worker-1
    volumes:
      - kokoro-models:/models/kokoro
    deploy:
      resources:
        limits:
          memory: 1536M
        reservations:
          memory: 768M
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; r=redis.from_url('redis://redis:6379/0'); r.ping()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    logging: *logging
    restart: unless-stopped
    networks:
      - agentvoicebox-net

  llm-worker:
    build:
      context: .
      dockerfile: workers/Dockerfile.llm
    container_name: agentvoicebox_llm-worker
    hostname: llm-worker
    environment:
      REDIS_URL: redis://redis:6379/0
      LLM_DEFAULT_PROVIDER: ${LLM_DEFAULT_PROVIDER:-groq}
      GROQ_API_KEY: ${GROQ_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      WORKER_ID: llm-worker-1
      CIRCUIT_BREAKER_THRESHOLD: "5"
      CIRCUIT_BREAKER_TIMEOUT: "30"
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; r=redis.from_url('redis://redis:6379/0'); r.ping()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging: *logging
    restart: unless-stopped
    networks:
      - agentvoicebox-net

  # ===========================================================================
  # OBSERVABILITY
  # ===========================================================================

  prometheus:
    image: prom/prometheus:v2.52.0
    container_name: agentvoicebox_prometheus
    hostname: prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=3d"
      - "--storage.tsdb.retention.size=500MB"
    ports:
      - "25008:9090"
    volumes:
      - ./observability/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    logging: *logging
    restart: unless-stopped
    networks:
      - agentvoicebox-net

  grafana:
    image: grafana/grafana:10.4.0
    container_name: agentvoicebox_grafana
    hostname: grafana
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_ROOT_URL: http://localhost:25009
    ports:
      - "25009:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./observability/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    depends_on:
      - prometheus
    logging: *logging
    restart: unless-stopped
    networks:
      - agentvoicebox-net

  # ===========================================================================
  # ADMIN UI - Static HTML Files Server
  # ===========================================================================

  admin-ui:
    image: nginx:alpine
    container_name: agentvoicebox_admin-ui
    hostname: admin-ui
    ports:
      - "25011:80"
    volumes:
      - ../advanced-voice.html:/usr/share/nginx/html/advanced-voice.html:ro
      - ../simple-chat.html:/usr/share/nginx/html/simple-chat.html:ro
      - ../test-ovos.html:/usr/share/nginx/html/test-ovos.html:ro
      - ../test-ovos.html:/usr/share/nginx/html/index.html:ro
    deploy:
      resources:
        limits:
          memory: 64M
        reservations:
          memory: 32M
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging: *logging
    restart: unless-stopped
    networks:
      - agentvoicebox-net

# =============================================================================
# VOLUMES
# =============================================================================

volumes:
  postgres-data:
  redis-data:
  kokoro-models:
  prometheus-data:
  grafana-data:

# =============================================================================
# NETWORKS
# =============================================================================

networks:
  agentvoicebox-net:
    driver: bridge
